<!DOCTYPE html>
<html>
<head>
  <title>ZCQRScanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      max-width: 1000px; 
      margin: 40px auto; 
      position: relative;
      background: #ffffff;
      color: #000000;
      transition: background 0.3s, color 0.3s;
      padding: 10px;
    }
    body.dark { background: #121212; color: #f1f1f1; }

    #topHeader { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; }
    #developer { font-size: 14px; color: #555; }
    body.dark #developer { color: #ccc; }
    #sheetInfo { text-align: right; font-size: 14px; color: #555; }
    body.dark #sheetInfo { color: #bbb; }

    #sheetInfo #status {
      margin-top: 4px;
      font-weight: bold;
      color: green;
    }
    body.dark #sheetInfo #status { color: #80e080; }

    #searchBox { padding: 8px; width: 50%; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchField { padding: 8px; width: 180px; margin-right: 10px; margin-bottom:10px; min-width: 120px; }
    #searchBtn, #clearBtn, #scanBtn, #uploadBtn, #darkModeBtn { 
      padding: 9px 15px; border: none; color: white; cursor: pointer; margin-bottom:10px; border-radius: 5px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    #searchBtn { background: #4285F4; margin-right: 5px; }
    #searchBtn:hover { background: #357AE8; }
    #clearBtn { background: #f44336; margin-right: 5px; }
    #clearBtn:hover { background: #d32f2f; }
    #scanBtn { background: #4CAF50; margin-right: 5px; }
    #scanBtn:hover { background: #45a049; }
    #uploadBtn { background: #FF9800; margin-right: 5px; }
    #uploadBtn:hover { background: #e68900; }
    #darkModeBtn { background: #333; margin-left: 5px; }
    body.dark #darkModeBtn { background: #666; color: #fff; }

    .spinner {
      border: 3px solid transparent;
      border-top: 3px solid white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      margin-left: 8px;
      animation: spin 1s linear infinite;
    }
    .spinner.scan { border-top-color: #fff; }
    .spinner.upload { border-top-color: #fff; }
    body.dark .spinner.scan { border-top-color: #fff; }
    body.dark .spinner.upload { border-top-color: #fff; }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #validatedMsg { 
      font-weight: bold; 
      display: none; 
      font-size: 22px; 
      margin-top: 10px;
      text-align: center;
    }

    #fields { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; border: 1px solid #ddd; }
    body.dark #fields { background: #1e1e1e; border-color: #444; }
    .field { display: flex; margin-bottom: 6px; flex-wrap: wrap; }
    .field-name { font-weight: bold; min-width: 200px; color: #333; white-space: nowrap; }
    body.dark .field-name { color: #ddd; }
    .field-value { flex: 1; color: #555; word-wrap: break-word; }
    body.dark .field-value { color: #ccc; }

    #counter { margin-top: 10px; font-weight: bold; color: #444; }
    body.dark #counter { color: #ccc; }

    #results { margin-top: 10px; border-collapse: collapse; width: 100%; overflow-x:auto; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; word-wrap: break-word; }
    th { background-color: #4285F4; color: white; font-weight: bold; text-align: left; }
    tr:hover { background-color: #e8f0fe; cursor: pointer; }
    body.dark th { background-color: #333; border-color: #555; }
    body.dark td { border-color: #555; }
    body.dark tr:hover { background-color: #444; }

    /* Scanner popup overlay */
    #scannerOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      padding: 10px;
      box-sizing: border-box;
    }
    #scannerBox {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #scannerBox h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      text-align: center;
      color: #333;
    }
    #video {
      width: 100% !important;
      height: auto !important;
      border-radius: 10px;
      background: #000;
    }
    #canvas { display: none; }
    #closeScanner {
      margin-top: 12px;
      padding: 8px 16px;
      background: #f44336;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #closeScanner:hover { background: #d32f2f; }
  </style>
</head>
<body>
  <!-- your HTML body unchanged ... -->

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    // ... all your existing JS unchanged until playBeep ...

    // --- Beep function ---
    function playBeep(type="success") {
      try {
        if (!window.beepAudioCtx) {
          window.beepAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        const audioCtx = window.beepAudioCtx;

        if (type === "success") {
          // ✅ success beep (sharp, short)
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain);
          gain.connect(audioCtx.destination);
          osc.type = "square";
          osc.frequency.value = 880;
          gain.gain.setValueAtTime(0.25, audioCtx.currentTime);
          osc.start();
          osc.stop(audioCtx.currentTime + 0.15);
        } else {
          // ❌ error beep (two-tone descending)
          const now = audioCtx.currentTime;
          const osc1 = audioCtx.createOscillator();
          const gain1 = audioCtx.createGain();
          osc1.connect(gain1);
          gain1.connect(audioCtx.destination);
          osc1.type = "sawtooth";
          osc1.frequency.setValueAtTime(600, now);
          gain1.gain.setValueAtTime(0.25, now);
          osc1.start(now);
          osc1.stop(now + 0.15);

          const osc2 = audioCtx.createOscillator();
          const gain2 = audioCtx.createGain();
          osc2.connect(gain2);
          gain2.connect(audioCtx.destination);
          osc2.type = "sawtooth";
          osc2.frequency.setValueAtTime(400, now + 0.16);
          gain2.gain.setValueAtTime(0.25, now + 0.16);
          osc2.start(now + 0.16);
          osc2.stop(now + 0.35);
        }
      } catch(e) {
        console.warn("Beep failed:", e);
      }
    }

    // ... rest of your original JS unchanged ...
    loadData();
  </script>
</body>
</html>


    // --- Scanner functionality ---
    const scannerOverlay = document.getElementById("scannerOverlay");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let scanning = false;
    let videoStream = null;

    scanBtn.addEventListener("click", async () => {
      scannerOverlay.style.display = "flex";
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = videoStream;
        video.setAttribute("playsinline", true);
        video.play();
        scanning = true;
        requestAnimationFrame(tick);
      } catch(err) {
        alert("Camera access denied.");
      }
    });

    document.getElementById("closeScanner").addEventListener("click", closeScanner);

    function closeScanner() {
      scanning = false;
      scannerOverlay.style.display = "none";
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
    }

    function tick() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        if (code) {
          scanning = false;
          closeScanner();
          handleQRResult(code.data, true);
          return;
        }
      }
      requestAnimationFrame(tick);
    }

    uploadBtn.addEventListener("click", () => document.getElementById("uploadQR").click());
    document.getElementById("uploadQR").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        const img = new Image();
        img.onload = function() {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
          if (code) {
            handleQRResult(code.data, true);
          } else {
            alert("No QR code found in image.");
            playBeep("error");
            flashRed();
          }
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    function handleQRResult(data, fromScanOrUpload=false) {
      const searchField = document.getElementById("searchField").value;
      const result = sheetData.find(row => row[searchField] && String(row[searchField]).trim().toLowerCase() === data.trim().toLowerCase());

      const validatedMsg = document.getElementById("validatedMsg");
      if (result) {
        fillFields(result);
        showResults([result]);
        validatedMsg.textContent = "VERIFIED DATA!";
        validatedMsg.style.color = "green";
        validatedMsg.style.display = "block";
        playBeep("success");
      } else {
        clearFields();
        showResults([]);
        validatedMsg.textContent = "NO RECORD FOUND!";
        validatedMsg.style.color = "red";
        validatedMsg.style.display = "block";
        playBeep("error");
        if (fromScanOrUpload) flashRed(); // ✅ only flash for scan/upload
      }
    }

    function flashRed() {
      document.body.style.background = "#ffcccc";
      setTimeout(() => {
        document.body.style.background = "";
      }, 200);
    }

    loadData();
  </script>
</body>
</html>
